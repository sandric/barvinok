<h1><%= @keyboard.name %></h1>

<h2><%= @commit.name %></h2>


<%= link_to 'Fork', fork_user_keyboard_commit_path(@user.name, @keyboard.name, @commit), :method => :post %>

<%= link_to 'New Commit', new_user_keyboard_commit_path(@user.name, @keyboard.name) %>

<%= link_to 'Diff', diff_user_keyboard_commit_path(@user.name, @keyboard.name, @commit) %>


<div id="app">
</div>

<div id="editor">
</div>


<%= javascript_tag do %>

	window.createEditor = function(initialKeyboardData, keyboardData) {

    var editorElement = document.getElementById("editor");

    if (keyboardData) {

      window.editor = CodeMirror.MergeView(editorElement, {
        orig: initialKeyboardData,
        value: initialKeyboardData,
        lineNumbers: true,
        mode: "application/ld+json",
        highlightDifferences: true
      });

      window.editor.editor().on("change", function(editor, change) {
        yizhackclj.db.serialization.set_keyboard_data(editor.getValue()); 
      });

      window.resizeEditor();

    } else {

      window.editor = CodeMirror(editorElement, {
        value: initialKeyboardData,
        lineNumbers: true,
        mode: "application/ld+json",
        readOnly: true
      });
    }

    editorElement.className += "hidden";
  }


  function mergeViewHeight(mergeView) {
    function editorHeight(editor) {
      if (!editor) return 0;
      return editor.getScrollInfo().height;
    }
    return Math.max(editorHeight(mergeView.leftOriginal()),
                    editorHeight(mergeView.editor()),
                    editorHeight(mergeView.rightOriginal()));
  }

  window.resizeEditor = function() {
    var mergeView = window.editor;
    var height = mergeViewHeight(mergeView);
    for(;;) {
      if (mergeView.leftOriginal())
        mergeView.leftOriginal().setSize(null, height);
      mergeView.editor().setSize(null, height);
      if (mergeView.rightOriginal())
        mergeView.rightOriginal().setSize(null, height);

      var newHeight = mergeViewHeight(mergeView);
      if (newHeight >= height) break;
      else height = newHeight;
    }
    mergeView.wrap.style.height = height + "px";
  }

	yizhackclj.core.initialize("<%= j raw @commit.as_json %>", false);

<% end %>